<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XAUUSD Analysis - GPT-4.1, Claude 3.7 & Perplexity Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Set chart to 4000x4000 */
        #tradingview-widget-container {
            height: 4000px; /* Set height */
            width: 4000px;  /* Set fixed width */
            margin: auto; /* Center the fixed-width chart if container is wider */
            overflow: auto; /* Add scrollbars if content overflows */
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">XAUUSD Analysis with GPT-4.1, Claude 3.7 & Perplexity Pro</h1>

        <!-- TradingView Widget Container -->
        <div id="tradingview-widget-container" class="mb-4">
            <div id="tradingview-chart"></div>
            <div class="tradingview-widget-copyright">
                <a href="https://www.tradingview.com/" rel="noopener nofollow" target="_blank">
                    <span class="blue-text">Track all markets on TradingView</span>
                </a>
            </div>
        </div>
        <!-- End TradingView Widget Container -->
        
        <div class="row mb-4">
            <div class="col">
                <button id="analyzeBtn" class="btn btn-primary w-100">Analyze Current Market</button>
            </div>
        </div>

        <div id="loading" class="d-none">
            <div class="text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
            <p class="text-center mt-2">Analyzing market conditions...</p>
        </div>

        <div id="results" class="d-none">
            <!-- Results will be populated by JavaScript -->
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- TradingView Widget Script -->
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <script type="text/javascript">
    new TradingView.widget(
      {
      "autosize": false,
      "width": 4000,
      "height": 4000,
      "symbol": "OANDA:XAUUSD", 
      "interval": "15",
      "timezone": "Etc/UTC",
      "theme": "light", 
      "style": "1", 
      "locale": "en",
      "enable_publishing": false,
      "hide_side_toolbar": false,
      "allow_symbol_change": true,
      "container_id": "tradingview-widget-container" 
    }
      );
    </script>
    <!-- End TradingView Widget Script -->
    <script>
    let pollingInterval = null; // To store the interval ID
    let pollCount = 0; // To prevent infinite polling
    const MAX_POLLS = 40; // Max times to poll (40 * 3s = 120s = 2 mins)

    function fetchAnalysis() {
        // **Crucial:** Stop any previous polling and clear results completely
        clearResults();

        const resultsDiv = document.getElementById('results');
        const analyzeBtn = document.getElementById('analyzeBtn');

        // Disable button and show loading state
        if (analyzeBtn) analyzeBtn.disabled = true;
        resultsDiv.innerHTML = '<div class="d-flex justify-content-center align-items-center" style="min-height: 100px;"><div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"><span class="visually-hidden">Loading...</span></div><p class="ms-3 mb-0">Starting analysis...</p></div>';

        fetch('/analyze', { method: 'POST' })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => { throw new Error(err.error || `Server error: ${response.status}`) });
                }
                if (response.status === 202) {
                    return response.json();
                } else {
                    throw new Error('Unexpected response status from server when starting task.');
                }
            })
            .then(data => {
                if (data.task_id) {
                    // Update loading message and add progress bar
                    resultsDiv.innerHTML = `<div class="text-center"><p>Analysis started (Task ID: ${data.task_id}). Polling for results...</p><div class="progress" role="progressbar" aria-label="Analysis progress" aria-valuenow="0" aria-valuemin="0" aria-valuemax="${MAX_POLLS}" style="height: 20px; max-width: 500px; margin: 10px auto;"><div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%">0%</div></div></div>`;
                    pollCount = 0; // Reset poll count for the new task
                    pollingInterval = setInterval(() => pollResults(data.task_id), 3000);
                } else {
                    throw new Error('Server did not return a task ID.');
                }
            })
            .catch(error => {
                console.error('Error starting analysis:', error);
                resultsDiv.innerHTML = `<div class="alert alert-danger" role="alert">Error starting analysis: ${error.message}</div>`;
                 if (analyzeBtn) analyzeBtn.disabled = false; // Re-enable button on error
            });
    }

    function pollResults(taskId) {
        pollCount++;
        console.log(`Polling for task ${taskId}, attempt ${pollCount}`);

        const progressBarDiv = document.querySelector('#results .progress-bar');
        if (progressBarDiv) {
             const progressPercent = Math.min(100, Math.round((pollCount / MAX_POLLS) * 100));
             progressBarDiv.style.width = `${progressPercent}%`;
             progressBarDiv.textContent = `${progressPercent}%`;
             progressBarDiv.setAttribute('aria-valuenow', pollCount);
        }

        if (pollCount > MAX_POLLS) {
            clearInterval(pollingInterval);
            pollingInterval = null;
            const resultsDiv = document.getElementById('results');
            // Keep the progress bar visible but add a timeout message
            if (resultsDiv) {
                 resultsDiv.innerHTML += `<div class="alert alert-warning mt-2 text-center" role="alert">Polling timed out after ${MAX_POLLS} checks. Server might still be processing.</div>`;
            }
            if (document.getElementById('analyzeBtn')) document.getElementById('analyzeBtn').disabled = false; // Re-enable button
            console.warn(`Stopped polling for task ${taskId} after ${MAX_POLLS} attempts.`);
            return;
        }

        fetch(`/results/${taskId}`)
            .then(response => {
                if (!response.ok) {
                     return response.json().then(err => { throw new Error(err.error || `Polling error: ${response.status}`) });
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'completed') {
                    clearInterval(pollingInterval);
                    pollingInterval = null;
                    console.log(`Task ${taskId} completed.`);
                    displayResults(data.data); // Display the actual results
                    if (document.getElementById('analyzeBtn')) document.getElementById('analyzeBtn').disabled = false; // Re-enable button
                } else if (data.status === 'pending') {
                    console.log(`Task ${taskId} is still pending...`);
                    // Continue polling...
                } else if (data.status === 'error') {
                    clearInterval(pollingInterval);
                    pollingInterval = null;
                    console.error(`Task ${taskId} failed:`, data.error);
                    document.getElementById('results').innerHTML = `<div class="alert alert-danger text-center" role="alert">Analysis failed: ${data.error || 'Unknown error'}</div>`;
                    if (document.getElementById('analyzeBtn')) document.getElementById('analyzeBtn').disabled = false; // Re-enable button
                } else {
                     throw new Error(`Unknown status received: ${data.status}`);
                }
            })
            .catch(error => {
                clearInterval(pollingInterval);
                pollingInterval = null;
                console.error('Error polling results:', error);
                document.getElementById('results').innerHTML = `<div class="alert alert-danger text-center" role="alert">Error checking results: ${error.message}</div>`;
                 if (document.getElementById('analyzeBtn')) document.getElementById('analyzeBtn').disabled = false; // Re-enable button
            });
    }

    function displayResults(data) {
        const resultsDiv = document.getElementById('results');
        if (!resultsDiv) return;
        // **Crucial: Clear previous content (loading indicators) before adding results**
        resultsDiv.innerHTML = '<h2>Analysis Results</h2>';

        let htmlContent = '';

        if (data && data.trend && data.trend.current_price) {
             htmlContent += `<p class="text-center"><strong>Current Price:</strong> ${data.trend.current_price}</p>`;
        } else {
             htmlContent += `<p class="text-center">Price information not available.</p>`;
        }

        htmlContent += '<div class="row">';
        // Use the actual keys from the response if available, otherwise default
        const modelsToDisplay = data && data.analyses ? Object.keys(data.analyses) : ['claude']; // Default or show what's available

        modelsToDisplay.forEach(modelKey => {
             const analysis = data.analyses[modelKey];
             // Handle cases where analysis might be missing or incomplete
             const cardHeader = analysis && analysis.model ? analysis.model : modelKey.charAt(0).toUpperCase() + modelKey.slice(1);
             const cardText = analysis && analysis.analysis ? analysis.analysis : 'Analysis not available for this model.';

            htmlContent += `<div class="col-md-4 mb-3">
                              <div class="card h-100">
                                <div class="card-header">${cardHeader}</div>
                                <div class="card-body">
                                  <p class="card-text">${cardText.replace(/\n/g, '<br>')}</p> <!-- Replace newlines with <br> for HTML display -->
                                </div>
                              </div>
                            </div>`;
        });

        // Add a fallback if no analyses were found at all
        if (modelsToDisplay.length === 0) {
            htmlContent += '<div class="col-12"><p class="text-center text-muted">No analysis data was returned from the server.</p></div>';
        }

        htmlContent += '</div>';
        resultsDiv.innerHTML += htmlContent; // Append the results cards
    }

    function clearResults() {
        // **Crucial: Stop any running interval timer**
        if (pollingInterval) {
            clearInterval(pollingInterval);
            pollingInterval = null;
            console.log("Cleared previous polling interval.");
        }
        pollCount = 0; // Reset counter

        const resultsDiv = document.getElementById('results');
        if (resultsDiv) {
            resultsDiv.innerHTML = ''; // Clear the display area
        }
        // Re-enable button if it was disabled
        const analyzeBtn = document.getElementById('analyzeBtn');
        if (analyzeBtn) analyzeBtn.disabled = false;

    }

    // Attach event listener *after* the DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
        const analyzeBtn = document.getElementById('analyzeBtn');
        if (analyzeBtn) {
            analyzeBtn.addEventListener('click', fetchAnalysis);
        } else {
            console.error("Analyze button not found!");
        }
    });

    </script>
    <!-- <script src="{{ url_for('static', filename='js/main.js') }}"></script> --> <!-- Temporarily commented out if not needed -->
</body>
</html>