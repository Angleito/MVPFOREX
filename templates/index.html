<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XAUUSD Analysis - GPT-4.1, Claude 3.7 & Perplexity Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Set chart to 720x720 */
        #tradingview-widget-container {
            height: 720px; /* Set height */
            width: 720px;  /* Set fixed width */
            margin: auto; /* Center the fixed-width chart if container is wider */
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="mb-4">XAUUSD Analysis with GPT-4.1, Claude 3.7 & Perplexity Pro</h1>

        <!-- TradingView Widget Container -->
        <div id="tradingview-widget-container" class="mb-4">
            <div id="tradingview-chart"></div>
            <div class="tradingview-widget-copyright">
                <a href="https://www.tradingview.com/" rel="noopener nofollow" target="_blank">
                    <span class="blue-text">Track all markets on TradingView</span>
                </a>
            </div>
        </div>
        <!-- End TradingView Widget Container -->
        
        <div class="row mb-4">
            <div class="col">
                <button id="analyzeBtn" class="btn btn-primary w-100">Analyze Current Market</button>
            </div>
        </div>

        <div id="loading" class="d-none">
            <div class="text-center">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
            <p class="text-center mt-2">Analyzing market conditions...</p>
        </div>

        <div id="results" class="d-none">
            <!-- Results will be populated by JavaScript -->
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- TradingView Widget Script -->
    <script type="text/javascript" src="https://s3.tradingview.com/tv.js"></script>
    <script type="text/javascript">
    new TradingView.widget(
      {
      "autosize": true,
      "symbol": "OANDA:XAUUSD", // Specify OANDA source for XAUUSD
      "interval": "5", // 5-minute interval
      "timezone": "Etc/UTC",
      "theme": "light", // Can be "dark" or "light"
      "style": "1", // 1 = Candles, 2 = Bars, etc.
      "locale": "en",
      "enable_publishing": false,
      "hide_side_toolbar": false,
      "allow_symbol_change": true,
      "container_id": "tradingview-chart" // Target the inner div
    }
      );
    </script>
    <!-- End TradingView Widget Script -->
    <script>
    let pollingInterval = null; // To store the interval ID
    let pollCount = 0; // To prevent infinite polling
    const MAX_POLLS = 40; // Max times to poll (40 * 3s = 120s = 2 mins)

    function fetchAnalysis() {
        // Clear previous results and stop any existing polling
        clearResults();
        if (pollingInterval) {
            clearInterval(pollingInterval);
            pollingInterval = null;
        }
        pollCount = 0;

        const resultsDiv = document.getElementById('results');
        resultsDiv.innerHTML = '<div class="spinner-border text-primary" role="status"><span class="visually-hidden">Loading...</span></div> <p>Starting analysis... Please wait.</p>';

        // Call the new POST endpoint to start the task
        fetch('/analyze', { method: 'POST' }) // Use POST
            .then(response => {
                if (!response.ok) {
                    // Handle immediate errors starting the task
                    return response.json().then(err => { throw new Error(err.error || `Server error: ${response.status}`) });
                }
                if (response.status === 202) { // 202 Accepted means task started
                    return response.json();
                } else {
                    // Should not happen if backend returns 202 correctly
                    throw new Error('Unexpected response status from server when starting task.');
                }
            })
            .then(data => {
                if (data.task_id) {
                    // Added progress bar display
                    resultsDiv.innerHTML = `<p>Analysis started (Task ID: ${data.task_id}). Waiting for results... This may take a minute.</p><div class="progress" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="${MAX_POLLS}" style="height: 20px;"><div class="progress-bar progress-bar-striped progress-bar-animated" style="width: 0%">Polling...</div></div>`;
                    // Start polling
                    pollingInterval = setInterval(() => pollResults(data.task_id), 3000); // Poll every 3 seconds
                } else {
                    throw new Error('Server did not return a task ID.');
                }
            })
            .catch(error => {
                console.error('Error starting analysis:', error);
                resultsDiv.innerHTML = `<div class="alert alert-danger" role="alert">Error starting analysis: ${error.message}</div>`;
            });
    }

    function pollResults(taskId) {
        pollCount++;
        console.log(`Polling for task ${taskId}, attempt ${pollCount}`);

        // Update progress bar visually
        const progressBar = document.querySelector('#results .progress-bar');
        if (progressBar) {
             const progressPercent = Math.min(100, (pollCount / MAX_POLLS) * 100);
             progressBar.style.width = `${progressPercent}%`;
             progressBar.textContent = `Polling (${pollCount}/${MAX_POLLS})...`; // Update text
             progressBar.setAttribute('aria-valuenow', pollCount);
        }


        if (pollCount > MAX_POLLS) {
            clearInterval(pollingInterval);
            pollingInterval = null;
            // Modify results div to show timeout message, keeping existing content if needed
            const resultsDiv = document.getElementById('results');
            const timeoutMsg = document.createElement('div');
            timeoutMsg.className = 'alert alert-warning mt-2';
            timeoutMsg.role = 'alert';
            timeoutMsg.textContent = `Analysis timed out after ${MAX_POLLS} checks. The server might still be processing.`;
            if(resultsDiv) resultsDiv.appendChild(timeoutMsg);
            console.warn(`Stopped polling for task ${taskId} after ${MAX_POLLS} attempts.`);
            return;
        }

        fetch(`/results/${taskId}`)
            .then(response => {
                if (!response.ok) {
                    // Handle errors during polling (e.g., 404 Not Found, 500 Server Error)
                     return response.json().then(err => { throw new Error(err.error || `Polling error: ${response.status}`) });
                }
                return response.json();
            })
            .then(data => {
                if (data.status === 'completed') {
                    clearInterval(pollingInterval);
                    pollingInterval = null;
                    console.log(`Task ${taskId} completed.`);
                    if(progressBar) progressBar.parentElement.remove(); // Remove progress bar container
                    displayResults(data.data); // Use the existing display function
                } else if (data.status === 'pending') {
                    // It's still pending, do nothing, wait for next interval
                    console.log(`Task ${taskId} is still pending...`);
                    // Progress bar updated above
                } else if (data.status === 'error') {
                    clearInterval(pollingInterval);
                    pollingInterval = null;
                    console.error(`Task ${taskId} failed:`, data.error);
                    if(progressBar) progressBar.parentElement.remove(); // Remove progress bar container
                    document.getElementById('results').innerHTML = `<div class="alert alert-danger" role="alert">Analysis failed: ${data.error || 'Unknown error'}</div>`;
                } else {
                     // Unexpected status
                     throw new Error(`Unknown status received: ${data.status}`);
                }
            })
            .catch(error => {
                clearInterval(pollingInterval);
                pollingInterval = null;
                console.error('Error polling results:', error);
                 if(progressBar) progressBar.parentElement.remove(); // Remove progress bar container
                // Display error message, clearing previous potentially misleading status
                document.getElementById('results').innerHTML = `<div class="alert alert-danger" role="alert">Error checking analysis results: ${error.message}</div>`;
            });
    }

    function displayResults(data) {
        const resultsDiv = document.getElementById('results');
        // Ensure resultsDiv exists and clear it before adding new content
        if (!resultsDiv) return;
        resultsDiv.innerHTML = '<h2>Analysis Results</h2>'; // Clear previous content (like progress bar message)

        let htmlContent = ''; // Start fresh html content

        if (data && data.trend) {
             htmlContent += `<p><strong>Current Price:</strong> ${data.trend.current_price || 'N/A'}</p>`;
        } else {
             htmlContent += `<p>Trend information not available.</p>`;
        }

        htmlContent += '<div class="row">';
        const models = ['claude', 'gpt4', 'perplexity'];
        models.forEach(modelKey => {
            const analysis = (data && data.analyses) ? data.analyses[modelKey] : null;
            const cardHeader = analysis ? (analysis.model || modelKey.charAt(0).toUpperCase() + modelKey.slice(1)) : modelKey.charAt(0).toUpperCase() + modelKey.slice(1);
            const cardText = analysis ? (analysis.analysis || 'No analysis generated.') : 'Analysis not available.';

            htmlContent += `<div class="col-md-4 mb-3">
                              <div class="card h-100"> <!-- Use h-100 for equal height cards -->
                                <div class="card-header">${cardHeader}</div>
                                <div class="card-body">
                                  <p class="card-text">${cardText}</p>
                                </div>
                              </div>
                            </div>`;
        });
        htmlContent += '</div>';
        resultsDiv.innerHTML += htmlContent; // Append the generated results HTML
    }

    function clearResults() {
        const resultsDiv = document.getElementById('results');
        if (resultsDiv) {
            resultsDiv.innerHTML = '';
        }
         if (pollingInterval) {
            clearInterval(pollingInterval);
            pollingInterval = null;
        }
        pollCount = 0;
    }

    // Attach event listener
    document.getElementById('analyzeBtn').addEventListener('click', fetchAnalysis);

    </script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>